import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

print("Testing the AI-generated code with the actual dataset...")
print("="*60)

# Load the actual dataset (this replaces the commented line in analysis.py)
df = pd.read_csv('store_sales.csv')

print(f"Dataset shape: {df.shape}")
print(f"Columns: {list(df.columns)}")
print(f"Product categories: {df['product_category'].unique()}")
print("\nFirst few rows:")
print(df.head())

print("\n" + "="*60)
print("TESTING THE GENERATED CODE FROM OUR AGENTS:")
print("="*60)

# Test the exact code generated by our python_coder agent
print("\n1. Testing bar chart code (generated by python_coder agent)...")

# Grouping the data by product category and calculating total revenue
revenue_by_category = df.groupby('product_category')['revenue'].sum().reset_index()

print("Revenue by category:")
print(revenue_by_category.round(2))

# Creating a bar chart
plt.figure(figsize=(10, 6))
sns.barplot(x='product_category', y='revenue', data=revenue_by_category)
plt.title('Total Revenue by Product Category')
plt.xlabel('Product Category')
plt.ylabel('Revenue')
plt.xticks(rotation=45)
plt.tight_layout()
plt.savefig('revenue_by_category.png', dpi=150, bbox_inches='tight')
plt.close()
print("âœ… Bar chart created and saved as 'revenue_by_category.png'")

# Test additional visualizations mentioned in the project plan
print("\n2. Testing additional EDA from the strategist plan...")

# Convert date column to datetime
df['date'] = pd.to_datetime(df['date'])
df['month'] = df['date'].dt.to_period('M')

# Monthly revenue trends
monthly_revenue = df.groupby('month')['revenue'].sum().reset_index()
monthly_revenue['month_str'] = monthly_revenue['month'].astype(str)

plt.figure(figsize=(12, 6))
sns.lineplot(x='month_str', y='revenue', data=monthly_revenue)
plt.title('Monthly Revenue Trends')
plt.xlabel('Month')
plt.ylabel('Total Revenue')
plt.xticks(rotation=45)
plt.tight_layout()
plt.savefig('monthly_revenue_trends.png', dpi=150, bbox_inches='tight')
plt.close()
print("âœ… Monthly revenue trends chart created and saved")

# Correlation analysis (from strategist plan)
correlation = df['units_sold'].corr(df['revenue'])
print(f"\nðŸ“Š Correlation between units_sold and revenue: {correlation:.3f}")

# Summary statistics
print(f"\nðŸ“ˆ Total revenue across all categories: ${df['revenue'].sum():,.2f}")
print(f"ðŸ“¦ Total units sold: {df['units_sold'].sum():,}")
print(f"ðŸ“… Date range: {df['date'].min()} to {df['date'].max()}")

print("\n" + "="*60)
print("âœ… ALL TESTS PASSED! Both agents worked perfectly:")
print("  â€¢ Strategist: Created comprehensive analysis plan")
print("  â€¢ Python Coder: Generated working, executable code")
print("  â€¢ Real dataset: Code runs successfully with actual data")
print("="*60)
